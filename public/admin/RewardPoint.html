<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Give Rewards/Points</title>
    <link rel="stylesheet" href="style.css">
    <script src="./RewardPoint.js"></script>
</head>
<body>
    <button class="back-button" onclick="window.location.href='index.html'">
        <i class="fa-solid fa-arrow-left"></i> 
        <span>Back</span>
    </button>
      <header class="header">
        <h1>Give Rewards
            <i class="fas fa-user" style="color: #007bff;"></i>
        </h1>
    </header>
    <div class="container">
        <h2>Give Points</h2>
        <label for="selectCourseQuiz">Quiz</label>
        <select name="selectCourseQuiz" id="selectCourseQuiz" onchange="getUserQuizRank(this.value)">
            <option value="">Please select a quiz</option>
        </select>
        <button onclick="addUsersPoints()">Add Points</button>
        <table id="UserQuizScore">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Name</th>
                    <th>Score</th>
                    <th>Time</th>
                    <th>Add points amount</th><!-- Default t1 300, t2 250, t3 200, t4 150, t5 100, other (Score >= 50) 50 -->
                </tr>
            </thead>
        </table>

        <h2>Reward Requirements</h2>
        <table id="UsersRewards">
            <thead>
                <tr>
                    <th>UserID</th><!-- 改为name -->
                    <th>Time</th>
                    <th>Reward</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
        </table>

        <h2>Point Rank</h2>
        <table id="UsersPoint">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Name</th>
                    <th>Points</th>
                </tr>
            </thead>
        </table>
    </div>
    <script>
        function getUsersPoint() {
            fetch('/api/getUsersPoint')
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('UsersPoint');
                data.forEach((user, index) => {
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.Name}</td>
                        <td>${user.RewardPoint}</td>
                    `;
                });
            });
        }

        function getUsersRewards() {
            fetch('/api/getUsersRewards')
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('UsersRewards');
                data.forEach(reward => {
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${reward.UserID}</td>
                        <td>${reward.RewardTime}</td>
                        <td>${reward.RewardID}</td>
                        <td>${reward.Status === 2 ? 'Completed' : 'In Progress'}</td>
                        <td>
                            <button onclick="markCompleted(${reward.RewardID})" ${reward.Status === 2 ? 'disabled' : ''}>Completed</button>
                        </td>
                    `;
                });
            });
        }

        function markCompleted(rewardID) {
            fetch(`/api/markUserRewardCompleated/${rewardID}`, {
                method: 'POST'
            })
            .then(() => {
                getUsersRewards();
                getUsersPoint();
            });
        }

        function getCourseQuiz() {
            fetch('/api/getAllCourseQuizzes')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('selectCourseQuiz');
                data.forEach(quiz => {
                    const option = document.createElement('option');
                    option.value = quiz.QuizID;
                    option.innerText = `${quiz.CourseName} - ${quiz.QuizName}`;
                    select.appendChild(option);
                });
            });
        }

        function getUserQuizRank(QuizID) {
            fetch(`/api/getCourseQuizRank?QuizID=${QuizID}`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('UserQuizScore');
                data.forEach((user, index) => {
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.Name}</td>
                        <td>${user.Score}</td>
                        <td>${user.Time}</td>
                        <td><input type="number" id="points${user.UserID}" value="${index + 1 == 1 ? 300 : index + 1 == 2 ? 250 : index + 1 == 3 ? 200 : index + 1 == 4 ? 150 : index + 1 == 5 ? 100 : 50}"></td>
                    `;
                });
            });
        }

        function addUsersPoints() {
            const points = document.querySelectorAll('input[type="number"]');
            const userID = document.getElementById('UserQuizScore').rows[1].cells[1].innerText;

            points.forEach(point => {
                fetch(`/api/addUserPoints/${userID}/increase/${point.value}`, {
                    method: 'POST'
                });
            });
            getUsersPoint();
            alert('Points added successfully');
        }

        document.addEventListener('DOMContentLoaded', () => {
            getUsersPoint();
            getUsersRewards();
            getCourseQuiz();
        });
    </script>
</body>
</html>